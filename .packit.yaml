---
specfile_path: newa.spec
files_to_sync:
  - newa.spec
  - .packit.yaml
sync_changelog: true

upstream_package_name: newa
downstream_package_name: newa

upstream_project_url: https://github.com/RedHatQE/newa
issue_repository: https://github.com/RedHatQE/newa

srpm_build_deps:
  - hatch
  - python3-hatch-vcs

jobs:

  # Build pull requests
  - job: copr_build
    trigger: pull_request
    targets:
      - fedora-all
      - epel-9
    enable_net: false
    actions:
      create-archive:
        - hatch build -t sdist
        - bash -c "ls dist/newa-*.tar.gz"
      get-current-version:
        # Use `dev888` instead of the last version digit to make
        # builds older than the final release and newer than
        # copr builds from main. Remove the remaining suffix
        # generated by `hatch version` as well so that build
        # with the latest timestamp always wins.
        - bash -c "hatch version | sed -E 's/\\.[0-9]+\\.dev.*/.dev888/'"

  # Build commits to main
  - job: copr_build
    trigger: commit
    branch: main
    targets:
      - fedora-all
      - epel-9
    enable_net: false
    list_on_homepage: true
    preserve_project: true
    release_suffix: "{PACKIT_PROJECT_BRANCH}"
    actions:
      create-archive:
        - hatch build -t sdist
        - bash -c "ls dist/newa-*.tar.gz"
      get-current-version:
        # Get rid of the the final version digit to make copr
        # builds older than the final release
        - bash -c "hatch version | sed -E 's/\\.[0-9]+\\.dev/.dev/'"

  # Release to copr
  - job: copr_build
    trigger: release
    targets:
      - fedora-all
      - epel-9
    enable_net: false
    list_on_homepage: true
    preserve_project: true
    owner: "ksrot"
    project: newa
    actions:
      create-archive:
        - hatch build -t sdist
        - bash -c "ls dist/newa-*.tar.gz"
      get-current-version:
        - hatch version
